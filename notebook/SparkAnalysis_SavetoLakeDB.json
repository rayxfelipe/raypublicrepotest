{
	"name": "SparkAnalysis_SavetoLakeDB",
	"properties": {
		"folder": {
			"name": "OR DHS"
		},
		"nbformat": 4,
		"nbformat_minor": 2,
		"bigDataPool": {
			"referenceName": "SparkPool2",
			"type": "BigDataPoolReference"
		},
		"sessionProperties": {
			"driverMemory": "28g",
			"driverCores": 4,
			"executorMemory": "28g",
			"executorCores": 4,
			"numExecutors": 2,
			"runAsWorkspaceSystemIdentity": false,
			"conf": {
				"spark.dynamicAllocation.enabled": "false",
				"spark.dynamicAllocation.minExecutors": "2",
				"spark.dynamicAllocation.maxExecutors": "2",
				"spark.autotune.trackingId": "f0981fd8-78c1-40e6-b3b0-ade7ede06b5d"
			}
		},
		"metadata": {
			"saveOutput": true,
			"synapse_widget": {
				"version": "0.1",
				"state": {
					"f316acc8-9e8d-453c-8cd0-e9c5db1dc84a": {
						"type": "Synapse.DataFrame",
						"sync_state": {
							"table": {
								"rows": [
									{
										"0": "2022",
										"1": "Q3",
										"2": "128399228",
										"4": "113604663",
										"5": "242003891",
										"6": "2022Q3",
										"7": "1270612715"
									},
									{
										"0": "2022",
										"1": "Q2",
										"2": "146711474",
										"3": "27517183",
										"4": "125601448",
										"5": "299830105",
										"6": "2022Q2",
										"7": "1408396551"
									},
									{
										"0": "2022",
										"1": "Q1",
										"2": "154838908",
										"3": "37514840",
										"4": "118726682",
										"5": "311080430",
										"6": "2022Q1",
										"7": "1326753255"
									},
									{
										"0": "2021",
										"1": "Q4",
										"2": "160839619",
										"3": "40030593",
										"4": "129339606",
										"5": "330209818",
										"6": "2021Q4",
										"7": "1444182968"
									},
									{
										"0": "2021",
										"1": "Q3",
										"2": "177312461",
										"3": "43306300",
										"4": "127835686",
										"5": "348454447",
										"6": "2021Q3",
										"7": "1427996423"
									},
									{
										"0": "2021",
										"1": "Q2",
										"2": "180221314",
										"3": "42402734",
										"4": "138637185",
										"5": "361261233",
										"6": "2021Q2",
										"7": "1562124823"
									},
									{
										"0": "2021",
										"1": "Q1",
										"2": "162113746",
										"3": "40273985",
										"4": "118115586",
										"5": "320503317",
										"6": "2021Q1",
										"7": "1339073897"
									},
									{
										"0": "2020",
										"1": "Q4",
										"2": "154674842",
										"3": "42391987",
										"4": "117878979",
										"5": "314945808",
										"6": "2020Q4",
										"7": "1330075859"
									},
									{
										"0": "2020",
										"1": "Q3",
										"2": "169514115",
										"3": "43386101",
										"4": "119280698",
										"5": "332180914",
										"6": "2020Q3",
										"7": "1343153401"
									},
									{
										"0": "2020",
										"1": "Q2",
										"2": "137517998",
										"3": "30947989",
										"4": "101890876",
										"5": "270356863",
										"6": "2020Q2",
										"7": "1152349557"
									}
								],
								"schema": [
									{
										"key": "0",
										"name": "Calendar_Year",
										"type": "string"
									},
									{
										"key": "1",
										"name": "Quarter",
										"type": "string"
									},
									{
										"key": "2",
										"name": "Excise_Tax",
										"type": "string"
									},
									{
										"key": "3",
										"name": "Cultivation_Tax",
										"type": "string"
									},
									{
										"key": "4",
										"name": "Sales_Tax",
										"type": "string"
									},
									{
										"key": "5",
										"name": "Total_Tax",
										"type": "string"
									},
									{
										"key": "6",
										"name": "Year_Quarter",
										"type": "string"
									},
									{
										"key": "7",
										"name": "Taxable_Sales",
										"type": "string"
									}
								],
								"truncated": false
							},
							"isSummary": false,
							"language": "scala"
						},
						"persist_state": {
							"view": {
								"type": "details",
								"chartOptions": {
									"chartType": "bar",
									"aggregationType": "count",
									"categoryFieldKeys": [
										"0"
									],
									"seriesFieldKeys": [
										"0"
									],
									"isStacked": false
								}
							}
						}
					},
					"68f07261-95a3-4b29-affd-4e921cafde3e": {
						"type": "Synapse.DataFrame",
						"sync_state": {
							"table": {
								"rows": [
									{
										"0": "2022",
										"1": "Q3",
										"2": "128399228",
										"4": "113604663",
										"5": "242003891",
										"6": "2022Q3",
										"7": "1270612715"
									},
									{
										"0": "2022",
										"1": "Q2",
										"2": "146711474",
										"3": "27517183",
										"4": "125601448",
										"5": "299830105",
										"6": "2022Q2",
										"7": "1408396551"
									},
									{
										"0": "2022",
										"1": "Q1",
										"2": "154838908",
										"3": "37514840",
										"4": "118726682",
										"5": "311080430",
										"6": "2022Q1",
										"7": "1326753255"
									},
									{
										"0": "2021",
										"1": "Q4",
										"2": "160839619",
										"3": "40030593",
										"4": "129339606",
										"5": "330209818",
										"6": "2021Q4",
										"7": "1444182968"
									},
									{
										"0": "2021",
										"1": "Q3",
										"2": "177312461",
										"3": "43306300",
										"4": "127835686",
										"5": "348454447",
										"6": "2021Q3",
										"7": "1427996423"
									},
									{
										"0": "2021",
										"1": "Q2",
										"2": "180221314",
										"3": "42402734",
										"4": "138637185",
										"5": "361261233",
										"6": "2021Q2",
										"7": "1562124823"
									},
									{
										"0": "2021",
										"1": "Q1",
										"2": "162113746",
										"3": "40273985",
										"4": "118115586",
										"5": "320503317",
										"6": "2021Q1",
										"7": "1339073897"
									},
									{
										"0": "2020",
										"1": "Q4",
										"2": "154674842",
										"3": "42391987",
										"4": "117878979",
										"5": "314945808",
										"6": "2020Q4",
										"7": "1330075859"
									},
									{
										"0": "2020",
										"1": "Q3",
										"2": "169514115",
										"3": "43386101",
										"4": "119280698",
										"5": "332180914",
										"6": "2020Q3",
										"7": "1343153401"
									},
									{
										"0": "2020",
										"1": "Q2",
										"2": "137517998",
										"3": "30947989",
										"4": "101890876",
										"5": "270356863",
										"6": "2020Q2",
										"7": "1152349557"
									},
									{
										"0": "2020",
										"1": "Q1",
										"2": "112691216",
										"3": "27635008",
										"4": "77540464",
										"5": "217866688",
										"6": "2020Q1",
										"7": "874484055"
									},
									{
										"0": "2019",
										"1": "Q4",
										"2": "86896273",
										"3": "24662913",
										"4": "70924162",
										"5": "182483348",
										"6": "2019Q4",
										"7": "799177192"
									},
									{
										"0": "2019",
										"1": "Q3",
										"2": "84887286",
										"3": "22809108",
										"4": "65838591",
										"5": "173534985",
										"6": "2019Q3",
										"7": "742689966"
									},
									{
										"0": "2019",
										"1": "Q2",
										"2": "75731295",
										"3": "23037243",
										"4": "60369668",
										"5": "159138206",
										"6": "2019Q2",
										"7": "681987559"
									},
									{
										"0": "2019",
										"1": "Q1",
										"2": "63702235",
										"3": "17277125",
										"4": "50697347",
										"5": "131676707",
										"6": "2019Q1",
										"7": "579052475"
									},
									{
										"0": "2018",
										"1": "Q4",
										"2": "57134451",
										"3": "17305538",
										"4": "49219539",
										"5": "123659528",
										"6": "2018Q4",
										"7": "563926086"
									},
									{
										"0": "2018",
										"1": "Q3",
										"2": "55452365",
										"3": "12965879",
										"4": "42660678",
										"5": "111078922",
										"6": "2018Q3",
										"7": "487899374"
									},
									{
										"0": "2018",
										"1": "Q2",
										"2": "43202987",
										"3": "4963720",
										"4": "45452521",
										"5": "93619228",
										"6": "2018Q2",
										"7": "520042047"
									},
									{
										"0": "2018",
										"1": "Q1",
										"2": "35867466",
										"3": "1849146",
										"4": "35511626",
										"5": "73228238",
										"6": "2018Q1",
										"7": "408509470"
									}
								],
								"schema": [
									{
										"key": "0",
										"name": "Calendar_Year",
										"type": "string"
									},
									{
										"key": "1",
										"name": "Quarter",
										"type": "string"
									},
									{
										"key": "2",
										"name": "Excise_Tax",
										"type": "string"
									},
									{
										"key": "3",
										"name": "Cultivation_Tax",
										"type": "string"
									},
									{
										"key": "4",
										"name": "Sales_Tax",
										"type": "string"
									},
									{
										"key": "5",
										"name": "Total_Tax",
										"type": "string"
									},
									{
										"key": "6",
										"name": "Year_Quarter",
										"type": "string"
									},
									{
										"key": "7",
										"name": "Taxable_Sales",
										"type": "string"
									}
								],
								"truncated": false
							},
							"isSummary": false,
							"language": "scala"
						},
						"persist_state": {
							"view": {
								"type": "details",
								"chartOptions": {
									"chartType": "bar",
									"aggregationType": "count",
									"categoryFieldKeys": [
										"0"
									],
									"seriesFieldKeys": [
										"0"
									],
									"isStacked": false
								}
							}
						}
					},
					"4270cca2-7a03-4fe3-8c50-b5bf3404803f": {
						"type": "Synapse.DataFrame",
						"sync_state": {
							"table": {
								"rows": [
									{
										"0": "2019",
										"1": "Q4",
										"2": "86896273",
										"3": "24662913",
										"4": "70924162",
										"5": "182483348",
										"6": "2019Q4",
										"7": "799177192"
									},
									{
										"0": "2019",
										"1": "Q3",
										"2": "84887286",
										"3": "22809108",
										"4": "65838591",
										"5": "173534985",
										"6": "2019Q3",
										"7": "742689966"
									},
									{
										"0": "2019",
										"1": "Q2",
										"2": "75731295",
										"3": "23037243",
										"4": "60369668",
										"5": "159138206",
										"6": "2019Q2",
										"7": "681987559"
									},
									{
										"0": "2019",
										"1": "Q1",
										"2": "63702235",
										"3": "17277125",
										"4": "50697347",
										"5": "131676707",
										"6": "2019Q1",
										"7": "579052475"
									}
								],
								"schema": [
									{
										"key": "0",
										"name": "Calendar_Year",
										"type": "string"
									},
									{
										"key": "1",
										"name": "Quarter",
										"type": "string"
									},
									{
										"key": "2",
										"name": "Excise_Tax",
										"type": "string"
									},
									{
										"key": "3",
										"name": "Cultivation_Tax",
										"type": "string"
									},
									{
										"key": "4",
										"name": "Sales_Tax",
										"type": "string"
									},
									{
										"key": "5",
										"name": "Total_Tax",
										"type": "string"
									},
									{
										"key": "6",
										"name": "Year_Quarter",
										"type": "string"
									},
									{
										"key": "7",
										"name": "Taxable_Sales",
										"type": "string"
									}
								],
								"truncated": false
							},
							"isSummary": false,
							"language": "scala"
						},
						"persist_state": {
							"view": {
								"type": "details",
								"chartOptions": {
									"chartType": "bar",
									"aggregationType": "count",
									"categoryFieldKeys": [
										"0"
									],
									"seriesFieldKeys": [
										"0"
									],
									"isStacked": false
								}
							}
						}
					}
				}
			},
			"enableDebugMode": false,
			"kernelspec": {
				"name": "synapse_pyspark",
				"display_name": "Synapse PySpark"
			},
			"language_info": {
				"name": "python"
			},
			"a365ComputeOptions": {
				"id": "/subscriptions/499bc654-f84c-46c2-952c-b30be508f78c/resourceGroups/SynapseMgdVnet-Demo/providers/Microsoft.Synapse/workspaces/raysynapsemgdvnet/bigDataPools/SparkPool2",
				"name": "SparkPool2",
				"type": "Spark",
				"endpoint": "https://raysynapsemgdvnet.dev.azuresynapse.net/livyApi/versions/2019-11-01-preview/sparkPools/SparkPool2",
				"auth": {
					"type": "AAD",
					"authResource": "https://dev.azuresynapse.net",
					"authHeader": null
				},
				"sparkVersion": "3.3",
				"nodeCount": 10,
				"cores": 4,
				"memory": 28,
				"extraHeader": null
			},
			"sessionKeepAliveTimeout": 30
		},
		"cells": [
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"microsoft": {
						"language": "python"
					},
					"collapsed": false
				},
				"source": [
					"%%pyspark\r\n",
					"df = spark.read.load('abfss://dcc@datalakaeacctindemorg.dfs.core.windows.net/CannabisTaxRevenues.csv', format='csv', header='true')\r\n",
					"display(df.limit(10))"
				],
				"execution_count": 6
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"df.show()\r\n",
					"df.printSchema()\r\n",
					"df.select('Calendar_Year').show()\r\n",
					"df.filter(df['Calendar_Year'] == \"2018\").show()"
				],
				"execution_count": 7
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"pd_df = df.toPandas()\r\n",
					"pd_df.info()\r\n",
					"pd_df.describe()\r\n",
					"pd_df.head()"
				],
				"execution_count": 8
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"pd_df['Calendar_Year'] = pd_df['Calendar_Year'].astype(int)\r\n",
					"pd_df['Quarter'] = pd_df['Quarter'].astype(str)\r\n",
					"pd_df['Excise_Tax'] = pd_df['Excise_Tax'].astype(int)\r\n",
					"pd_df['Cultivation_Tax'] = pd_df['Cultivation_Tax'].astype(str)\r\n",
					"pd_df['Total_Tax'] = pd_df['Total_Tax'].astype(int)\r\n",
					"pd_df['Taxable_Sales'] = pd_df['Taxable_Sales'].astype(int)\r\n",
					"\r\n",
					"import matplotlib.pyplot as plt\r\n",
					"pd_df.hist(bins=10, figsize=(15,8))\r\n",
					"plt.show()"
				],
				"execution_count": 9
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"pd_df.plot(figsize=(10,5))\r\n",
					"pd_df.plot.scatter(x='Excise_Tax', y='Calendar_Year', figsize=(5,5))\r\n",
					"# pd_df.plot.scatter(x='Number of Returns Filed', y='16. Total Cannabis Excise Tax Due', figsize=(5,5))\r\n",
					"\r\n",
					"plt.show()"
				],
				"execution_count": 10
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"collapsed": false
				},
				"source": [
					"df.printSchema()\r\n",
					"# display(df.limit(10))\r\n",
					"display(df)\r\n",
					"\r\n",
					"spark.sql(\"CREATE DATABASE IF NOT EXISTS cannabis\")\r\n",
					"df.write.mode(\"overwrite\").saveAsTable(\"cannabis.taxrevenue\")"
				],
				"execution_count": 11
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"microsoft": {
						"language": "python"
					},
					"collapsed": false
				},
				"source": [
					"%%pyspark\r\n",
					"sparksql_df = spark.sql(\"\"\"\r\n",
					"   SELECT *\r\n",
					"   FROM cannabis.taxrevenue\r\n",
					"   WHERE Calendar_Year == \"2019\"\r\n",
					"\"\"\") \r\n",
					"display(sparksql_df)\r\n",
					"sparksql_df.write.mode(\"overwrite\").saveAsTable(\"cannabis.taxrevenue2019\")"
				],
				"execution_count": 12
			}
		]
	}
}